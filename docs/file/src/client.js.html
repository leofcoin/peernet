<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/client.js | @leofcoin/peernet</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client.js~PeernetClient.html">PeernetClient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/disco-peer.js~DiscoPeer.html">DiscoPeer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/peer-info.js~PeerInfo.html">PeerInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/peernet.js~Peernet.html">Peernet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-debug">debug</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-expected">expected</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#codec">codec</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/codec/codec-format-interface.js~FormatInterface.html">FormatInterface</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/codec/codec.js~PeernetCodec.html">PeernetCodec</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#dht">dht</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/dht/dht.js~DhtEarth.html">DhtEarth</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#hash">hash</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hash/hash.js~DiscoHash.html">DiscoHash</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#http">http</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-http">http</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#http-client">http/client</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/http/client/api.js~api.html">api</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/http/client/http-client.js~HttpClientApi.html">HttpClientApi</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/http/client/storage.js~LeofcoinStorageClient.html">LeofcoinStorageClient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-client">client</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#messages">messages</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/messages/data-response.js~DataMessageResponse.html">DataMessageResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/messages/data.js~DataMessage.html">DataMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/messages/dht-response.js~DHTMessageResponse.html">DHTMessageResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/messages/dht.js~DHTMessage.html">DHTMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/messages/peernet.js~PeernetMessage.html">PeernetMessage</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/client.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import crypto from &apos;crypto&apos;
import swarm from &apos;@geut/discovery-swarm-webrtc&apos;
import wrtc from &apos;wrtc&apos;
import Pubsub from &apos;@vandeurenglenn/little-pubsub&apos;
import DiscoPeer from &apos;./disco-peer.js&apos;
import sha256 from &apos;crypto-js/sha256&apos;

globalThis.connections = new Map()
globalThis.pubsub = globalThis.pubsub || new Pubsub()

export default class PeernetClient {
  constructor(options = {}) {
    if (!options.id) options.id = Buffer.from(&apos;00000000000000000000000000000000&apos;)
    
    this.id = options.id
    
    this.sw = swarm({
      id: options.id,
      bootstrap: [&apos;wss://discovery-swarm.herokuapp.com&apos;, &apos;ws://localhost:4000&apos;],
      simplePeer: {
        wrtc
      }
    })
     
    this.topic = Buffer.from(sha256(&apos;peernet-v0.1.0&apos;).toString())
     
    this.sw.join(this.topic.slice(0, 32))
     
    const arrayOfPeers = this.sw.getPeers()
    
    this.sw.on(&apos;connection&apos;, async (connection, info) =&gt; {
      // connected
      const id = info.id.toString()
      if (id === this.id.toString()) return
      
      const channel = connection.channelName
      let channels = [channel]
      let peer
      if (connections.has(id)) {
        const value = connections.get(id)
        const _channels = value.channels
        channels = [ ...channels, ..._channels ]
        peer = value.peer
      } else {
        peer = new DiscoPeer(id, connection)
        pubsub.publish(&apos;peer:connected&apos;, peer)
      }
      connections.set(id, {channels, peer})
      // connection.on(&apos;data&apos;, (data) =&gt; console.log({data}))
      // connection.write(&apos;peerId&apos;)
    });
    
    this.sw.on(&apos;candidates-updated&apos;, async (channel, candidates) =&gt; {
      // TODO: Channels ...
      for (const candidate of candidates) {
        const id = candidate.toString()
        let channels = [channel]
        if (id === this.id.toString()) return
        console.log({id});
        
        if (!connections.has(id)) {
          const connection = await this.sw.connect(channel, candidate)
          const peer = new DiscoPeer(id, connection)
          connections.set(id, {channels, peer})
          pubsub.publish(&apos;peer:connected&apos;, peer)
        } else {
          const value = connections.get(id)
          const _channels = value.channels
          channels = [ ...channels, ..._channels ]
          connections.set(id, {channels, peer: value.peer})
        }
      
      }
    })
    
    this.sw.on(&apos;connection-closed&apos;, (connection, info) =&gt; {
      setTimeout(() =&gt; {
        if (connections.has(info.id.toString())) connections.delete(info.id.toString())
      }, 500);
    })
    
    if (globalThis.onbeforeunload) globalThis.onbeforeunload = () =&gt; {
      this.sw.leave(this.topic)
      return setTimeout(() =&gt; {
        
      }, 1000)
    }
  }
  
  _peers() {
    return this.sw.getPeers()
  }
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
